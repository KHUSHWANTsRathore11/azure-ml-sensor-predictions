# PR Validation Pipeline
# 
# Purpose: Validate configuration files and check ML asset versions
# Trigger: Pull Requests to develop, release/*, and main branches

name: PR-Validation-$(Date:yyyyMMdd)-$(Rev:r)

trigger: none  # No CI trigger, only PRs

pr:
  branches:
    include:
      - develop
      - release/*
      - main
  paths:
    include:
      - config/**
      - components/**
      - src/**
      - pipelines/**
      - scripts/**

parameters:
  - name: runDataValidation
    displayName: 'Run Delta Lake Data Validation'
    type: boolean
    default: false
  # TEMPORARILY DISABLED - Set to true to validate Delta Lake data quality
  # Requires Azure storage access and proper configuration
  # TODO: Re-enable once storage access is configured in variable group
  
  - name: deltaTablePath
    displayName: 'Delta Table Path'
    type: string
    default: '/processed/sensor_data'
  
  - name: dataValidationMinRows
    displayName: 'Minimum Expected Rows'
    type: number
    default: 1000
  
  - name: freshnessHours
    displayName: 'Data Freshness Threshold (hours)'
    type: number
    default: 48

variables:
  # Pipeline execution settings (validation thresholds, Python version, etc.)
  # Managed via Azure DevOps Library â†’ Variable Groups
  # See: docs/VARIABLE_GROUPS_SETUP.md
  - group: mlops-pipeline-settings
  - group: mlops-shared-variables  # Storage account and container names
  
  # PR target branch detection
  - name: targetBranch
    value: $[coalesce(variables['System.PullRequest.TargetBranch'], 'refs/heads/develop')]
  - name: isDevPR
    value: $[eq(variables.targetBranch, 'refs/heads/develop')]
  - name: isReleasePR
    value: $[eq(variables.targetBranch, 'refs/heads/release')]
  - name: isMainPR
    value: $[eq(variables.targetBranch, 'refs/heads/main')]

stages:
  - stage: ValidateConfigs
    displayName: 'Validate Configuration Files'
    jobs:
      - job: ValidateYAML
        displayName: 'Validate YAML Files'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 0
        
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
        
          - script: pip install pyyaml jsonschema
            displayName: 'Install dependencies'
        
          # VALIDATE SCRIPTS FIRST - before using them!
          - script: |
              echo "ğŸ Validating scripts syntax..."
              
              # Check scripts/validation/ syntax first (we're about to use these!)
              if [ -d "scripts/validation" ]; then
                for script in scripts/validation/*.py; do
                  if [ -f "$script" ]; then
                    echo "Checking: $script"
                    python -m py_compile "$script" || exit 1
                  fi
                done
                echo "âœ… All validation scripts have valid syntax"
              fi
              
              # Check scripts/pipeline/ syntax
              if [ -d "scripts/pipeline" ]; then
                for script in scripts/pipeline/*.py; do
                  if [ -f "$script" ]; then
                    echo "Checking: $script"
                    python -m py_compile "$script" || exit 1
                  fi
                done
                echo "âœ… All pipeline scripts have valid syntax"
              fi
            displayName: 'Validate Scripts Syntax'
        
          # Now safe to use the validated scripts
          - script: python scripts/validation/validate_circuits.py --config config/circuits.yaml
            displayName: 'Validate circuits.yaml'
        
          - script: python scripts/validation/validate_environment.py --config components/environments/sensor-forecasting-env.yaml
            displayName: 'Validate environment.yaml'
        
          - script: python scripts/validation/validate_components.py --components-dir components
            displayName: 'Validate component files'
        
          - script: python scripts/validation/validate_pipeline_compute.py --pipelines-dir pipelines
            displayName: 'Validate pipeline compute references'


  # ============================================
  # DATA VALIDATION (TEMPORARILY DISABLED)
  # ============================================
  # This stage validates Delta Lake data quality but requires:
  # - Azure storage access configured
  # - mlops-shared-variables group with storageAccountName and dataContainer
  # - Service connection with read permissions to storage
  # 
  # Currently runs: ONLY for Production PRs (to main branch)
  # To enable: Set runDataValidation=true when running the pipeline
  # ============================================
  
  - stage: ValidateData
    displayName: 'Validate Delta Lake Data Quality [Prod PRs Only - DISABLED]'
    dependsOn: ValidateConfigs
    condition: and(succeeded(), eq(variables.isProdPR, 'True'), eq('${{ parameters.runDataValidation }}', 'true'))
    jobs:
      - job: DataValidation
        displayName: 'Schema & Quality Checks'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
          
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
          
          - script: pip install deltalake pandas
            displayName: 'Install validation dependencies'
          
          - task: AzureCLI@2
            displayName: 'Validate Delta Lake Data'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "ğŸ” Validating Delta Lake data quality..."
                echo ""
                
                # Run data validation with parameterized settings
                python scripts/validate_delta_data.py \
                  --table-path '${{ parameters.deltaTablePath }}' \
                  --storage-account $(storageAccountName) \
                  --container $(dataContainer) \
                  --min-rows ${{ parameters.dataValidationMinRows }} \
                  --freshness-hours ${{ parameters.freshnessHours }}
                
                EXIT_CODE=$?
                
                if [ $EXIT_CODE -eq 0 ]; then
                  echo ""
                  echo "âœ… Data validation passed"
                else
                  echo ""
                  echo "âŒ Data validation failed"
                  echo "   Please review data quality issues before merging"
                  exit 1
                fi
            continueOnError: false

  - stage: CheckMLAssets
    displayName: 'Check ML Asset Versions'
    dependsOn: ValidateConfigs
    jobs:
      - job: CheckVersions
        displayName: 'Check Asset Versions in Target Workspace'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 0
          
          - template: templates/install-ml-extension.yml
          
          - task: AzureCLI@2
            displayName: 'Check ML Asset Versions'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "ğŸ” Checking if ML asset versions already exist..."
                
                # Determine which workspace to check based on target branch
                TARGET_BRANCH="${SYSTEM_PULLREQUEST_TARGETBRANCH}"
                
                if [[ -z "$TARGET_BRANCH" ]]; then
                  echo "â„¹ï¸  Not a PR build, skipping version checks"
                  exit 0
                fi
                
                echo "Target branch: $TARGET_BRANCH"
                
                if [[ "$TARGET_BRANCH" == "refs/heads/develop" ]]; then
                  WORKSPACE="$(mlopsDevWorkspace)"
                  RG="$(mlopsDevResourceGroup)"
                  ENV_NAME="Dev"
                elif [[ "$TARGET_BRANCH" == refs/heads/release/* ]]; then
                  WORKSPACE="$(mlopsTestWorkspace)"
                  RG="$(mlopsTestResourceGroup)"
                  ENV_NAME="Test"
                elif [[ "$TARGET_BRANCH" == "refs/heads/main" ]]; then
                  WORKSPACE="$(mlopsProdWorkspace)"
                  RG="$(mlopsProdResourceGroup)"
                  ENV_NAME="Prod"
                else
                  echo "âš ï¸  Unknown target branch: $TARGET_BRANCH"
                  echo "   Skipping version checks"
                  exit 0
                fi
                
                echo "Target workspace: $WORKSPACE ($ENV_NAME)"
                echo ""
                
                WARNINGS=0
                
                # Check Environment version
                echo "ğŸ“¦ Checking Environment version..."
                ENV_VERSION=$(grep "^version:" components/environments/sensor-forecasting-env.yaml | awk '{print $2}' | tr -d '"' | tr -d "'")
                ENV_NAME_VAL=$(grep "^name:" components/environments/sensor-forecasting-env.yaml | awk '{print $2}' | tr -d '"' | tr -d "'")
                
                if az ml environment show \
                  --name "$ENV_NAME_VAL" \
                  --version "$ENV_VERSION" \
                  --workspace-name "$WORKSPACE" \
                  --resource-group "$RG" &>/dev/null; then
                  echo "âš ï¸  WARNING: Environment $ENV_NAME_VAL:$ENV_VERSION already exists in $ENV_NAME workspace"
                  echo "   Consider incrementing the version if you made changes"
                  WARNINGS=$((WARNINGS + 1))
                else
                  echo "âœ… Environment $ENV_NAME_VAL:$ENV_VERSION is a new version"
                fi
                
                echo ""
                
                # Check Pipeline Component version
                echo "ğŸ“¦ Checking Pipeline Component version..."
                if [ -f "components/training-pipeline-component.yaml" ]; then
                  COMP_NAME=$(grep "^name:" components/training-pipeline-component.yaml | awk '{print $2}' | tr -d '"' | tr -d "'")
                  COMP_VERSION=$(grep "^version:" components/training-pipeline-component.yaml | awk '{print $2}' | tr -d '"' | tr -d "'")
                  
                  if az ml component show \
                    --name "$COMP_NAME" \
                    --version "$COMP_VERSION" \
                    --workspace-name "$WORKSPACE" \
                    --resource-group "$RG" &>/dev/null; then
                    echo "âš ï¸  WARNING: Pipeline component $COMP_NAME:$COMP_VERSION already exists in $ENV_NAME workspace"
                    echo "   Consider incrementing the version if you made changes"
                    WARNINGS=$((WARNINGS + 1))
                  else
                    echo "âœ… Pipeline component $COMP_NAME:$COMP_VERSION is a new version"
                  fi
                fi
                
                echo ""
                
                if [ $WARNINGS -gt 0 ]; then
                  echo "â„¹ï¸  Found $WARNINGS existing asset(s). Consider incrementing versions if changed."
                  echo "   Existing assets will be skipped during registration."
                else
                  echo "âœ… All assets are new versions"
                fi
            env:
              SYSTEM_PULLREQUEST_TARGETBRANCH: $(System.PullRequest.TargetBranch)

  - stage: LintAndFormat
    displayName: 'Code Quality Checks'
    dependsOn: ValidateConfigs
    jobs:
      - job: PythonLint
        displayName: 'Python Linting'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
          
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
          
          # Display which validation level is being used
          - script: |
              echo "ğŸ¯ Determining lint strictness based on target branch..."
              echo "Target branch: $(targetBranch)"
              
              if [ "$(isProdPR)" == "True" ]; then
                echo "ğŸ“Š Validation Level: STRICT (Production PR)"
                echo "##vso[task.setvariable variable=lintStrictness]strict"
                echo "##vso[task.setvariable variable=continueOnError]false"
              elif [ "$(isReleasePR)" == "True" ]; then
                echo "ğŸ“Š Validation Level: MODERATE (Release PR)"
                echo "##vso[task.setvariable variable=lintStrictness]moderate"
                echo "##vso[task.setvariable variable=continueOnError]false"
              else
                echo "ğŸ“Š Validation Level: LENIENT (Dev PR - warnings only)"
                echo "##vso[task.setvariable variable=lintStrictness]lenient"
                echo "##vso[task.setvariable variable=continueOnError]true"
              fi
            displayName: 'Determine Lint Strictness'
          
          - script: |
              echo "ğŸ” Checking Python code quality ($(lintStrictness) mode)..."
              pip install -q flake8 black
              
              # Check if src directory exists
              if [ -d "src" ]; then
                echo "Running flake8 on src/..."
                
                if [ "$(lintStrictness)" == "strict" ]; then
                  echo "   Mode: STRICT - Block on all errors and warnings"
                  flake8 src/ --count --max-complexity=10 --max-line-length=100 --show-source --statistics
                elif [ "$(lintStrictness)" == "moderate" ]; then
                  echo "   Mode: MODERATE - Block on errors only"
                  flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
                else
                  echo "   Mode: LENIENT - Warnings only, non-blocking"
                  flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
                fi
                
                echo ""
                echo "Checking code formatting with black..."
                if [ "$(lintStrictness)" == "strict" ]; then
                  black --check src/
                else
                  black --check src/ || echo "âš ï¸  Code not formatted with black (non-blocking)"
                fi
              else
                echo "â„¹ï¸  No src/ directory found, skipping Python linting"
              fi
              
              # Check scripts directory
              if [ -d "scripts" ]; then
                echo ""
                echo "Checking scripts directory..."
                if [ "$(lintStrictness)" == "strict" ]; then
                  flake8 scripts/ --count --max-complexity=10 --max-line-length=100 --show-source --statistics
                elif [ "$(lintStrictness)" == "moderate" ]; then
                  flake8 scripts/ --count --select=E9,F63,F7,F82 --show-source --statistics
                else
                  flake8 scripts/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
                fi
              fi
              
              echo ""
              echo "âœ… Python linting complete ($(lintStrictness) mode)"
            displayName: 'Lint Python Code'
            continueOnError: $(continueOnError)

  - stage: Summary
    displayName: 'Validation Summary'
    dependsOn:
      - ValidateConfigs
      - ValidateData
      - CheckMLAssets
      - LintAndFormat
    condition: always()
    jobs:
      - job: DisplaySummary
        displayName: 'Show Validation Results'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: |
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘          PR VALIDATION COMPLETE                       â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo ""
              echo "âœ… Configuration files validated"
              echo "âœ… ML asset versions checked"
              echo "âœ… Code quality checks completed"
              echo ""
              echo "Next steps:"
              echo "  1. Address any warnings or issues"
              echo "  2. Request PR review from team"
              echo "  3. Merge to trigger training/deployment pipeline"
            displayName: 'Validation Summary'
