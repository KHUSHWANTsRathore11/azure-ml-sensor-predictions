# Training Pipeline - Train Models in Dev Workspace (Restructured)
# 
# Purpose: Train models, register in Dev workspace, and optionally promote to Registry
# Branch: develop
# Trigger: Changes to config/circuits.yaml, components, or src packages
#
# Architecture: 7 granular stages for better control and error handling

name: Training-$(Date:yyyyMMdd)-$(Rev:r)

trigger:
  branches:
    include:
      - develop
  paths:
    include:
      - config/circuits.yaml
      - components/environments/sensor-forecasting-env.yaml
      - components/**
      - src/packages/**
      - scripts/**

pr: none  # PR validation handled by pr-validation-pipeline.yml

parameters:
  - name: manualCircuits
    displayName: 'Manual Circuit Override (leave as AUTO for git detection, or specify: PLANT001/CIRCUIT01,PLANT002/CIRCUIT02)'
    type: string
    default: 'AUTO'  # AUTO = use automatic git-based detection
  
  - name: skipPromotion
    displayName: 'Skip Promotion to Registry'
    type: boolean
    default: false
  # Set to true to only train and register, skip promotion

variables:
  # Workspace-specific Azure ML settings
  - group: mlops-dev-variables
  - group: mlops-registry-variables
  
  # Pipeline execution settings (monitoring, validation, retention, Python version, etc.)
  # All pipeline config now managed via Azure DevOps Library â†’ Variable Groups
  # See: docs/VARIABLE_GROUPS_SETUP.md
  - group: mlops-pipeline-settings


stages:
  # ============================================
  # STAGE 1: REGISTER ENVIRONMENT
  # ============================================
  - stage: RegisterEnvironment
    displayName: '1. Register Environment'
    jobs:
      - job: RegisterEnv
        displayName: 'Register Custom Environment'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 0
          
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
          
          - script: pip install pyyaml
            displayName: 'Install dependencies'
          
          - template: templates/install-ml-extension.yml
          - template: templates/configure-ml-defaults.yml
          
          - task: AzureCLI@2
            displayName: 'Register Custom Environment'
            name: registerEnv  # Name this step to reference outputs
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "ğŸ³ Checking environment in Dev workspace..."
                
                CONFIG_VERSION=$(grep "^version:" components/environments/sensor-forecasting-env.yaml | awk '{print $2}' | tr -d '"' | tr -d "'")
                ENV_NAME=$(grep "^name:" components/environments/sensor-forecasting-env.yaml | awk '{print $2}' | tr -d '"' | tr -d "'")
                echo "Environment: $ENV_NAME:$CONFIG_VERSION"
                
                # Check if environment already exists
                EXISTING_ENV=$(az ml environment show \
                  --name "$ENV_NAME" \
                  --version "$CONFIG_VERSION" 2>/dev/null || echo "not_found")
                
                if [[ "$EXISTING_ENV" == "not_found" ]]; then
                  echo "Version $CONFIG_VERSION not found. Registering new environment..."
                  
                  # Register environment - will fail if file is invalid or missing
                  if ! az ml environment create --file components/environments/sensor-forecasting-env.yaml; then
                    echo "âŒ Failed to register environment"
                    exit 1
                  fi
                  
                  echo "âœ… Environment registered: $ENV_NAME:$CONFIG_VERSION"
                  echo "##vso[task.setvariable variable=newEnvRegistered;isOutput=true]true"
                else
                  echo "âœ… Environment $ENV_NAME:$CONFIG_VERSION already exists. Skipping registration."
                  echo "##vso[task.setvariable variable=newEnvRegistered;isOutput=true]false"
                fi

  # ============================================
  # STAGE 2: PROMOTE ENVIRONMENT TO REGISTRY
  # ============================================
  - stage: PromoteEnvironment
    displayName: '2. Promote Environment to Registry'
    dependsOn: RegisterEnvironment
    # Only run if new environment was registered in Stage 1
    condition: and(succeeded('RegisterEnvironment'), eq(dependencies.RegisterEnvironment.outputs['RegisterEnv.registerEnv.newEnvRegistered'], 'true'))
    jobs:
      - deployment: PromoteEnvToRegistry
        displayName: 'Promote Environment (Approval Required)'
        environment: 'registry-promotion'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                
                - script: |
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘        ENVIRONMENT PROMOTION APPROVAL REQUEST             â•‘"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                    
                    CONFIG_VERSION=$(grep "^version:" components/environments/sensor-forecasting-env.yaml | awk '{print $2}' | tr -d '"' | tr -d "'")
                    ENV_NAME=$(grep "^name:" components/environments/sensor-forecasting-env.yaml | awk '{print $2}' | tr -d '"' | tr -d "'")
                    
                    echo "Environment: $ENV_NAME"
                    echo "Version:     $CONFIG_VERSION"
                    echo ""
                    echo "This environment will be promoted to the shared Azure ML Registry"
                    echo "for use in Test and Production deployments."
                    echo ""
                  displayName: 'Show Environment Details'
                
                - task: UsePythonVersion@0
                  inputs:
                    versionSpec: '$(pythonVersion)'
                
                - template: templates/install-ml-extension.yml
                
                - task: AzureCLI@2
                  displayName: 'Promote Environment to Registry'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "ğŸš€ Promoting environment to registry..."
                      
                      CONFIG_VERSION=$(grep "^version:" components/environments/sensor-forecasting-env.yaml | awk '{print $2}' | tr -d '"' | tr -d "'")
                      ENV_NAME=$(grep "^name:" components/environments/sensor-forecasting-env.yaml | awk '{print $2}' | tr -d '"' | tr -d "'")
                      
                      echo "Environment: $ENV_NAME:$CONFIG_VERSION"
                      
                      # Check if already exists in registry
                      if az ml environment show \
                        --name "$ENV_NAME" \
                        --version "$CONFIG_VERSION" \
                        --registry-name "$(registryName)" \
                        --resource-group "$(registryResourceGroup)" &>/dev/null; then
                        echo "â„¹ï¸  Environment already exists in registry, skipping"
                        exit 0
                      fi
                      
                      # Promote to registry
                      echo "Promoting $ENV_NAME:$CONFIG_VERSION to registry..."
                      az ml environment create \
                        --file components/environments/sensor-forecasting-env.yaml \
                        --registry-name "$(registryName)" \
                        --resource-group "$(registryResourceGroup)"
                      
                      if [ $? -eq 0 ]; then
                        echo "âœ… Environment promoted successfully"
                        
                        # Verify
                        if az ml environment show \
                          --name "$ENV_NAME" \
                          --version "$CONFIG_VERSION" \
                          --registry-name "$(registryName)" \
                          --resource-group "$(registryResourceGroup)" &>/dev/null; then
                          echo "âœ… Verified in registry"
                        else
                          echo "âš ï¸  Promoted but verification failed"
                          exit 1
                        fi
                      else
                        echo "âŒ Promotion failed"
                        exit 1
                      fi

  # ============================================
  # STAGE 3: REGISTER COMPONENTS
  # ============================================
  - stage: RegisterComponents
    displayName: '3. Register Components'
    dependsOn: RegisterEnvironment
    jobs:
      - job: RegisterAllComponents
        displayName: 'Register All Components'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
          
          - template: templates/install-ml-extension.yml
          - template: templates/configure-ml-defaults.yml
          
          - task: AzureCLI@2
            displayName: 'Register All Components'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "ğŸ“¦ Registering all components..."
                echo ""
                
                # Function to register a component
                register_component() {
                  local component_file=$1
                  local component_name=$(grep "^name:" "$component_file" | awk '{print $2}' | tr -d '"' | tr -d "'")
                  local component_version=$(grep "^version:" "$component_file" | awk '{print $2}' | tr -d '"' | tr -d "'")
                  
                  echo "Checking: $component_name:$component_version"
                  
                  # Check if this version already exists
                  if az ml component show --name "$component_name" --version "$component_version" &>/dev/null; then
                    echo "  âœ… Already exists, skipping"
                  else
                    echo "  ğŸ“¦ Registering..."
                    if az ml component create --file "$component_file"; then
                      echo "  âœ… Registered successfully"
                    else
                      echo "  âŒ Registration failed"
                      exit 1
                    fi
                  fi
                  echo ""
                }
                
                # Register pipeline components
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "ğŸ“‹ PIPELINE COMPONENTS"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                for component_file in components/pipelines/*.yaml; do
                  if [ -f "$component_file" ]; then
                    register_component "$component_file"
                  fi
                done
                
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "âœ… Component registration complete!"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # ============================================
  # STAGE 4: REGISTER MLTABLES
  # ============================================
  - stage: RegisterMLTables
    displayName: '4. Register MLTables'
    dependsOn: RegisterComponents
    jobs:
      - job: RegisterDataAssets
        displayName: 'Detect Changed Circuits & Register MLTables'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 0
          
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
          
          - script: pip install pyyaml
            displayName: 'Install dependencies'
          
          - template: templates/generate-circuit-configs.yml
          
          - task: AzureCLI@2
            displayName: 'Register MLTables'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                python scripts/pipeline/detect_changed_circuits.py \
                  --config config/circuits.yaml \
                  --manual-circuits '${{ parameters.manualCircuits }}' \
                  --workspace-name $(workspaceName) \
                  --resource-group $(resourceGroup)

  # ============================================
  # STAGE 5: SUBMIT TRAINING
  # ============================================
  - stage: SubmitTraining
    displayName: '5. Submit Training Jobs'
    dependsOn: RegisterMLTables
    jobs:
      - job: SubmitJobs
        displayName: 'Submit Training Jobs'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
          
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
          
          - script: pip install pyyaml
            displayName: 'Install dependencies'
          
          - template: templates/install-ml-extension.yml
          - template: templates/configure-ml-defaults.yml
          
          - task: AzureCLI@2
            displayName: 'Submit Training Jobs'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                python scripts/pipeline/submit_training_jobs.py \
                  --output training_jobs.json \
                  --pipeline-file pipelines/single-circuit-training.yaml \
                  --workspace-name $(workspaceName) \
                  --resource-group $(resourceGroup)
          
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Training Jobs Info'
            inputs:
              targetPath: 'training_jobs.json'
              artifact: 'training_jobs'

  # ============================================
  # STAGE 6: MONITOR TRAINING
  # ============================================
  - stage: MonitorTraining
    displayName: '6. Monitor Training Jobs'
    dependsOn: SubmitTraining
    jobs:
      - job: WaitForCompletion
        displayName: 'Wait for Training Completion'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: 'training_jobs'
              path: $(Pipeline.Workspace)
          
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
          
          - script: pip install azure-ai-ml azure-identity
            displayName: 'Install Azure ML SDK'
          
          - task: AzureCLI@2
            displayName: 'Monitor Training Jobs'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                python scripts/pipeline/monitor_training_jobs.py \
                  --training-jobs $(Pipeline.Workspace)/training_jobs.json \
                  --subscription-id $(subscriptionId) \
                  --resource-group $(resourceGroup) \
                  --workspace-name $(workspaceName) \
                  --max-wait-hours $(monitoringMaxWaitHours) \
                  --poll-interval $(monitoringPollIntervalSeconds) \
                  --output monitoring_result.json
          
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Monitoring Result'
            inputs:
              targetPath: 'monitoring_result.json'
              artifact: 'monitoring_result'

  # ============================================
  # STAGE 7: REGISTER MODELS
  # ============================================
  - stage: RegisterModels
    displayName: '7. Register Models'
    dependsOn: MonitorTraining
    jobs:
      - job: RegisterTrainedModels
        displayName: 'Register Trained Models in Dev Workspace'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
          
          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: 'training_jobs'
              path: $(Pipeline.Workspace)
          
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
          
          - script: pip install azure-ai-ml azure-identity pyyaml
            displayName: 'Install dependencies'
          
          - task: AzureCLI@2
            displayName: 'Register Models'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                python scripts/pipeline/register_models.py \
                  --training-jobs $(Pipeline.Workspace)/training_jobs.json \
                  --subscription-id $(subscriptionId) \
                  --resource-group $(resourceGroup) \
                  --workspace-name $(workspaceName) \
                  --output registered_models.json
          
          - task: PublishPipelineArtifact@1
              targetPath: 'registered_models.json'
              artifact: 'registered_models'

  # ============================================
  # STAGE 8: PROMOTE TO REGISTRY (PER-MODEL CHILD PIPELINES)
  # ============================================
  - stage: PromoteToRegistry
    displayName: '8. Promote to Registry (Per-Model Approval)'
    dependsOn: RegisterModels
    condition: and(succeeded(), ne('${{ parameters.skipPromotion }}', 'true'))
    jobs:
      - job: TriggerModelPromotions
        displayName: 'Trigger Promotion Pipelines'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
          
          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: 'registered_models'
              path: $(Pipeline.Workspace)
          
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
          
          - script: |
              echo "ğŸ“‹ Models ready for promotion (each gets individual approval):"
              echo ""
              python3 << 'EOF'
              import json
              with open('$(Pipeline.Workspace)/registered_models.json', 'r') as f:
                  data = json.load(f)
              models = data.get('models', [])
              
              # Group by plant
              by_plant = {}
              for model in models:
                  plant = model['plant_id']
                  if plant not in by_plant:
                      by_plant[plant] = []
                  by_plant[plant].append(model)
              
              for plant, plant_models in sorted(by_plant.items()):
                  print(f"\n{plant}: {len(plant_models)} model(s)")
                  for model in plant_models:
                      print(f"  - {model['model_name']}:v{model['version']}")
              
              print(f"\nğŸ“Œ Each model will trigger a separate pipeline run")
              print(f"ğŸ“Œ Approve each model individually in its own pipeline")
              EOF
            displayName: 'List Models for Promotion'
          
          - script: pip install requests
            displayName: 'Install dependencies'
          
          - task: Bash@3
            displayName: 'Trigger Child Pipelines'
            env:
              SYSTEM_ACCESSTOKEN: $(System.AccessToken)
            inputs:
              targetType: 'inline'
              script: |
                echo "ğŸš€ Triggering individual promotion pipelines..."
                echo ""
                
                # Get Azure DevOps context from predefined variables
                ORGANIZATION=$(echo "$(System.CollectionUri)" | sed 's|https://dev.azure.com/||' | sed 's|/||')
                PROJECT="$(System.TeamProject)"
                
                # Pipeline ID for promote-single-model-pipeline.yml
                # TODO: Update this with actual pipeline ID after first run
                PIPELINE_ID="<REPLACE_WITH_PIPELINE_ID>"
                
                python scripts/pipeline/trigger_model_promotions.py \
                  --registered-models "$(Pipeline.Workspace)/registered_models.json" \
                  --organization "$ORGANIZATION" \
                  --project "$PROJECT" \
                  --pipeline-id "$PIPELINE_ID" \
                  --output triggered_promotions.json
                
                if [ $? -eq 0 ]; then
                  echo ""
                  echo "âœ… All promotion pipelines triggered successfully"
                  echo "ğŸ“Œ Go to Pipelines to approve each model individually"
                else
                  echo "âŒ Some pipelines failed to trigger"
                  exit 1
                fi
          
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Triggered Pipelines Info'
            inputs:
              targetPath: 'triggered_promotions.json'
              artifact: 'triggered_promotions'
      

